<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Nginx泛域名添加https免费SSL证书Lets Encrypt(certbot)安装使用步骤
 · 非鱼笔记</title><meta name="description" content="Nginx泛域名添加https免费SSL证书Lets Encrypt(certbot)安装使用步骤
 - fredliu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.qzcool.com/atom.xml" title="非鱼笔记"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">非鱼笔记</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>INDEX</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>ARCHIVES</p></a><ul class="shortcut-icons"><a href="https://github.com/fredliu168" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">Nginx泛域名添加https免费SSL证书Lets Encrypt(certbot)安装使用步骤
</h1><div class="post-info">Mar 16, 2020</div><div class="post-content"><p>本文介绍如何在 nginx 服务器上使用免费的 Let’s Encrypt 凭证，提供 HTTPS 的安全加密网页。</p>
<p>本教程的安装环境是:</p>
<blockquote>
<p>阿里云Ubuntu 16.04.3 LTS (GNU/Linux 4.4.0-105-generic x86_64)</p>
</blockquote>
<p>本人服务器上安装路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/home/frp/0.21.0/certbot-auto</div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="STEP-1"><a href="#STEP-1" class="headerlink" title="STEP 1"></a><code>STEP 1</code></h2><p>从<code>Certbot</code>官方网站下载 <code>certbot-auto</code> 指令，並设定其执行权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://dl.eff.org/certbot-auto</div><div class="line">chmod a+x certbot-auto</div></pre></td></tr></table></figure></p>
<p><code>certbot-auto</code> 要放在哪裡都可以，建議一開始就找一個適合的地方放好，例如建立一個 <code>/opt/letsencrypt</code> 目錄，把 <code>certbot-auto</code> 放在這裡：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir /opt/letsencrypt</div><div class="line">mv certbot-auto /opt/letsencrypt/</div></pre></td></tr></table></figure></p>
<h2 id="STEP-2"><a href="#STEP-2" class="headerlink" title="STEP 2"></a><code>STEP 2</code></h2><p>執行 <code>certbot-auto</code>，讓它自動安裝所有相依套件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/letsencrypt/certbot-auto</div></pre></td></tr></table></figure></p>
<p>在执行安装<code>certbot-auto</code>过程中，阿里云服务器会提示下列错误:</p>
<blockquote>
<p>OSError: Command /opt/eff.org/certbot/venv/bin/python2.7 - setuptools pkg_resources pip wheel failed with error code 2  </p>
</blockquote>
<p>错误的原因是<code>certbot-auto</code>使用python2.7，但调用了python3的virtualenv，由于系统安装了多个版本的python的virtualenv，那么怎么删除呢？</p>
<p>解决方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apt-get purge python-virtualenv python3-virtualenv virtualenv</div><div class="line"></div><div class="line">pip install virtualenv</div></pre></td></tr></table></figure>
<p>然后在执行安装 <code>certbot-auto</code>，终于安装成功！！！</p>
<h2 id="STEP-3"><a href="#STEP-3" class="headerlink" title="STEP 3"></a><code>STEP 3</code></h2><p>执行<code>certbot-auto</code>生成泛域名证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo ./certbot-auto certonly \</div><div class="line">--server https://acme-v02.api.letsencrypt.org/directory \</div><div class="line"> --manual --preferred-challenges dns -d *.qzcool.com</div></pre></td></tr></table></figure></p>
<p>执行后会要求验证DNS TXT，提示信息如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">lease deploy a DNS TXT record under the name</div><div class="line">_acme-challenge.qzcool.com with the following value:</div><div class="line"></div><div class="line">QcvPzuizmydLs1AmJF-J9eWOfOW7T89i******</div><div class="line"></div><div class="line">Before continuing, verify the record is deployed.</div></pre></td></tr></table></figure></p>
<p>泛域名解析需要验证<code>DNS TXT</code>，需要到域名提供商里面设置，子域名设置为<code>_acme-challenge</code>，记录类型选<code>TXT</code>记录，把<code>QcvPzuizmydLs1AmJF-J9eWOfOW7T89i******</code>填在记录值那一栏，<br>配置后可以执行下面命令，看是否正确返回。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dig _acme-challenge.qzcool.com txt</div></pre></td></tr></table></figure></p>
<p><code>DNS TXT</code> 配置完后，按回车继续执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- Congratulations! Your certificate and chain have been saved at:</div><div class="line">  /etc/letsencrypt/live/qzcool.com/fullchain.pem</div><div class="line">  Your key file has been saved at:</div><div class="line">  /etc/letsencrypt/live/qzcool.com/privkey.pem</div><div class="line">  Your cert will expire on 2018-12-19. To obtain a new or tweaked</div><div class="line">  version of this certificate in the future, simply run certbot-auto</div><div class="line">  again. To non-interactively renew *all* of your certificates, run</div><div class="line">  &quot;certbot-auto renew&quot;</div></pre></td></tr></table></figure>
<p>然后获取证书成功，记住证书生成的目录，需要到Nginx里面配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/etc/letsencrypt/live/qzcool.com/fullchain.pem</div><div class="line"> /etc/letsencrypt/live/qzcool.com/privkey.pem</div></pre></td></tr></table></figure></p>
<p><strong>补充一下<code>花生壳</code>的坑</strong></p>
<blockquote>
<p>当时为了能内网映射公网，把域名转到<code>花生壳</code>网站，结果遇到了一系列的坑，原来免费的东西，在这里各种要钱，下面列举下：<br>泛域名解析10元/年<br>可添加无限子域名 20元/年<br>TXT记录 10元/年<br>CNAME记录设置 10元/年<br>URL跳转设置 10元/年<br>奉劝大家不要用花生壳的域名服务器，太坑了，使用内网映射服务可以使用免费的frp，我的另外一篇文章frp使用教程可以参考。</p>
</blockquote>
<h2 id="STEP-4"><a href="#STEP-4" class="headerlink" title="STEP 4"></a><code>STEP 4</code></h2><p>如果你是第一次使用<code>nginx</code>，可以用<code>certbot</code>帮你自动生成主域名<code>nginx</code>配置，然后在修改相关证书配置。<br>访问<a href="https://certbot.eff.org/，选择你使用的软件和系统，在这里我们选择nginx和Ubuntu" target="_blank" rel="external">https://certbot.eff.org/，选择你使用的软件和系统，在这里我们选择nginx和Ubuntu</a> 16.04.</p>
<p>安装相关软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install software-properties-common</div><div class="line">$ sudo add-apt-repository ppa:certbot/certbot</div><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install python-certbot-nginx</div></pre></td></tr></table></figure>
<p>生成证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo certbot --nginx</div></pre></td></tr></table></figure></p>
<p>根据提示输入要添加https的域名，最后提示生成成功，访问你的域名，发现能使用https访问。</p>
<p>使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx -t</div></pre></td></tr></table></figure></p>
<p>查看<code>nginx</code>的配置目录，我服务器上的配置目录<code>/etc/nginx/nginx.conf</code>，修改配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /etc/nginx/sites-enabled/default</div></pre></td></tr></table></figure></p>
<p>记得把<code>try_files $uri $uri/ =404;</code>这个注释掉，否则访问会出错，暂时没查这个是什么问题，修改配置如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># /etc/nginx/sites-enabled/default </div><div class="line">server_name *.qzcool.com; # managed by Certbot </div><div class="line">location / &#123;</div><div class="line">                # First attempt to serve request as file, then</div><div class="line">                # as directory, then fall back to displaying a 404. </div><div class="line">                proxy_pass http://172.17.0.1:8080;</div><div class="line">                proxy_set_header    Host            $host:80;</div><div class="line">                proxy_set_header    X-Real-IP       $remote_addr;</div><div class="line">                proxy_set_header    X-Forwarded-For           $proxy_add_x_forwarded_for;</div><div class="line">                proxy_hide_header   X-Powered-By; </div><div class="line">    #  try_files $uri $uri/ =404;</div><div class="line">        &#125; </div><div class="line">    listen [::]:443 ssl ipv6only=on; # managed by Certbot</div><div class="line">    listen 443 ssl; # managed by Certbot</div><div class="line">    ssl_certificate /etc/letsencrypt/live/dhbmw.com/fullchain.pem; # managed by Certbot</div><div class="line">    ssl_certificate_key /etc/letsencrypt/live/dhbmw.com/privkey.pem; # managed by Certbot</div><div class="line">    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot</div><div class="line">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot </div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">        listen 80 ;</div><div class="line">        server_name www.qzcool.com;</div><div class="line">        rewrite ^(.*)$ https://$host$1 permanent;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>nginx从新加载配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx -s reload</div></pre></td></tr></table></figure></p>
<h2 id="证书定时更新"><a href="#证书定时更新" class="headerlink" title="证书定时更新"></a>证书定时更新</h2><p>Let’s Encrypt 的憑證使用期限只有三個月，在憑證到期前的一個月可以使用 certbot-auto 來更新憑證，在實際更新之前我們可以加入 –dry-run 參數，先進行測試：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/letsencrypt/certbot-auto renew --dry-run</div></pre></td></tr></table></figure></p>
<p>若測試沒問題，就可以使用正式指令來更新：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/letsencrypt/certbot-auto renew --quiet --no-self-upgrade</div></pre></td></tr></table></figure></p>
<p>而為了方便起見，可以將這個更新指令寫在 /opt/letsencrypt/renew.sh 指令稿中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">/opt/letsencrypt/certbot-auto renew --quiet --no-self-upgrade --post-hook &quot;service nginx reload&quot;</div></pre></td></tr></table></figure></p>
<p>這裡我又加上一個 –post-hook 的設定，讓憑證更新完後，可以自動重新載入 nginx 伺服器的設定，讓憑證生效。</p>
<p>接著把這個 /opt/letsencrypt/renew.sh 指令稿寫進 crontab 中，<br>键入<code>crontab  -e</code> 编辑crontab服务文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># m h  dom mon dow   command</div><div class="line">30 2 * * 0 /opt/letsencrypt/renew.sh</div></pre></td></tr></table></figure>
<p>官方的建議是這個指令可以一天執行兩次，讓伺服器的憑證隨時保持在最新的狀態，這裡我是設定讓伺服器每週日凌晨兩點半進行憑證的檢查與更新，Certbot 只有在憑證到期前一個月才會進行更新，如果憑證尚未到期，就不會更新。</p>
<p><strong>crontab相关命令</strong>: </p>
<blockquote>
<p>查看该用户下的crontab服务是否创建成功， 用<code>crontab  -l</code>命令<br>启动crontab服务 <code>sudo service crond start</code><br>查看服务是否已经运行用 <code>ps -ax | grep cron</code></p>
</blockquote>
<h3 id="413-Request-Entity-Too-Large报错处理"><a href="#413-Request-Entity-Too-Large报错处理" class="headerlink" title="413 Request Entity Too Large报错处理"></a>413 Request Entity Too Large报错处理</h3><p>打开nginx主配置文件nginx.conf，一般在<br>vim /etc/nginx/nginx.conf<br>这个位置，找到http{}段并修改以下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">client_max_body_size 2m;</div></pre></td></tr></table></figure></p>
<p>当中的2m修改成你需要的允许文件大小。</p>
<p>参考:<br><a href="https://blog.gtwang.org/linux/secure-nginx-with-lets-encrypt-ssl-certificate-on-ubuntu-and-debian/" title="NGINX 使用 Let’s Encrypt 免費 SSL 憑證設定 HTTPS 安全加密網頁教學" target="_blank" rel="external">1.NGINX 使用 Let’s Encrypt 免費 SSL 憑證設定 HTTPS 安全加密網頁教學</a> </p>
<p><a href="https://certbot.eff.org/lets-encrypt/ubuntuxenial-nginx" target="_blank" rel="external">2.Certbot nginx下配置SSL</a></p>
</div></article></div><div id="disqus_thread"></div></div><script>var disqus_shortname = 'fishman-1';
var disqus_identifier = '2020/03/16/Nginx泛域名添加https免费SSL证书Lets-Encrypt-certbot-安装使用步骤/';
var disqus_title = 'Nginx泛域名添加https免费SSL证书Lets Encrypt(certbot)安装使用步骤
';
var disqus_url = 'https://blog.qzcool.com/2020/03/16/Nginx泛域名添加https免费SSL证书Lets-Encrypt-certbot-安装使用步骤/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//fishman-1.disqus.com/count.js" async></script></main><footer class="footer-container"><div class="paginator"><a href="/2020/01/14/iMac如何通过快捷键连接AirPods耳机/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2020 <a href="https://blog.qzcool.com">fredliu</a>,<a href='http://www.beian.miit.gov.cn'>备案编号:闽ICP备17012963号-1</a> powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"fishman",'auto');ga('send','pageview');</script></body></html>